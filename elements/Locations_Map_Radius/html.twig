<div id="mapid" style="height:{{ content.controls.height }}px;"></div>

<script type="text/javascript">
  (function(){
    const mapContainer = document.getElementById('mapid');
    if (!mapContainer) return;

    // Check if Leaflet is loaded
    if (typeof L === 'undefined') {
      console.error('Leaflet is not loaded');
      return;
    }

    // const locationsUrl = 'http://breakdance-pj-skips.local/wp-content/themes/breakdance-zero-theme-master/locations.json';
    
    const locationsUrl = '/wp-content/plugins/breakdance-custom-elements/elements/Locations_Map_Radius/locations.json';

    const map = L.map(mapContainer, {
        scrollWheelZoom: false
    }).setView([{{ content.controls.default_lat }}, {{ content.controls.default_long }}], {{ content.controls.zoom }});

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attributionControl: false
    }).addTo(map);

    map.attributionControl.remove();

    fetch(locationsUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(locations => {
            if (!Array.isArray(locations) || locations.length === 0) {
              console.warn('No valid locations found');
              return;
            }

            let bounds = [];

            // Determine which icon to use
            const customIconUrl = "{{content.controls.map_pin.url}}";
            
            let customIcon;
            if (customIconUrl && customIconUrl.trim() !== '') {
                // Use custom uploaded icon
                customIcon = L.icon({
                    iconUrl: customIconUrl,
                    iconSize: [40, 50],
                    iconAnchor: [20, 25],
                    popupAnchor: [0, -20]
                });
            } else {
                // Use CSS mask-based fallback icon
                customIcon = L.divIcon({
                    className: 'custom-map-pin-icon',
                    iconSize: [40, 50],
                    iconAnchor: [20, 25],
                    popupAnchor: [0, -20]
                });
            }

            locations.forEach(location => {
                const lat = parseFloat(location.lat);
                const lon = parseFloat(location.lon);
                
                // Validate coordinates
                if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                    bounds.push([lat, lon]);
                    
                    // Create popup content with location name as link and phone number
                    let popupContent = '';
                    
                    if (location.page_link) {
                        popupContent = `<a href="${location.page_link}">${location.name}</a>`;
                    } else {
                        popupContent = location.name;
                    }

                    if (location.phone) {
                        popupContent += `<br><a href="tel:${location.phone}">${location.phone}</a>`;
                    }

                    L.marker([lat, lon], { icon: customIcon })
                    .bindPopup(popupContent)
                    .addTo(map);

                } else {
                    console.warn('Invalid coordinates:', location);
                }
            });

            if (bounds.length > 0) {
                const latLngBounds = L.latLngBounds(bounds);
                map.fitBounds(latLngBounds);
                



                const center = latLngBounds.getCenter();
                let maxDistance = 0;

                bounds.forEach(point => {
                    const distance = map.distance(center, point);
                    if (distance > maxDistance) {
                        maxDistance = distance;
                    }
                });
              
             // console.log(maxDistance);
              

                // Add some padding to the circle
                const paddedRadius = maxDistance * {{ content.controls.radius }};

                L.circle(center, {
                    color: '{{ content.controls.colour }}',
                    fillColor: '{{ content.controls.fill_colour }}',
                    fillOpacity: '{{ content.controls.opacity }}',
                    radius: paddedRadius
                }).addTo(map);
            } else {
                console.warn('No valid coordinates found in locations data');
            }
            
           // console.log(paddedRadius);
        })
        .catch(error => {
          console.error('Error loading locations:', error);
          // Fallback: show a default view
          map.setView([{{ content.controls.default_lat }}, {{ content.controls.default_long }}], {{ content.controls.zoom }});
        });
})();
</script>

<style>
    .custom-map-pin-icon {
        background-color: {{ content.controls.colour }};
        -webkit-mask: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NDAgNjQwIj48cGF0aCBkPSJNMzIwIDY0QzIxNCA2NCAxMjggMTQ4LjQgMTI4IDI1Mi42QzEyOCAzNzEuOSAyNDguMiA1MTQuOSAyOTguNCA1NjkuNEMzMTAuMiA1ODIuMiAzMjkuOCA1ODIuMiAzNDEuNiA1NjkuNEMzOTEuOCA1MTQuOSA1MTIgMzcxLjkgNTEyIDI1Mi42QzUxMiAxNDguNCA0MjYgNjQgMzIwIDY0eiIvPjwvc3ZnPg==');
        mask: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NDAgNjQwIj48cGF0aCBkPSJNMzIwIDY0QzIxNCA2NCAxMjggMTQ4LjQgMTI4IDI1Mi42QzEyOCAzNzEuOSAyNDguMiA1MTQuOSAyOTguNCA1NjkuNEMzMTAuMiA1ODIuMiAzMjkuOCA1ODIuMiAzNDEuNiA1NjkuNEMzOTEuOCA1MTQuOSA1MTIgMzcxLjkgNTEyIDI1Mi42QzUxMiAxNDguNCA0MjYgNjQgMzIwIDY0eiIvPjwvc3ZnPg==');
        -webkit-mask-size: contain;
        mask-size: contain;
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-position: center;
        mask-position: center;
        width: 40px;
        height: 50px;
    }
</style>